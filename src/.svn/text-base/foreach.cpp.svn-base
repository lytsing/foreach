/* -*- mode: c++; c-basic-offset: 4; indent-tabs-mode: nil -*-

   Tue April 15 2008
   Copyright (C) 2008 deli <huangliqing@broncho.org>
   $Id$

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; version 2 of the License.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
*/

/*  Don't Repeat Yourself
                     -- Dave Thomas */

#include <iostream>
#include <getopt.h>
#include <cstdlib>

using namespace std;

void print_help();

const char* VERSION = "0.0.1"; //FIXME

const struct option long_options[] = {
    {"count", 1, NULL, 'c' },
    {"number", 1, NULL, 'n' },
    {"help", 0, NULL, 'h'},
    {"timeout", 1, NULL, 't'},
    {"version", 0, NULL, 'v' },
    {NULL, 0, NULL, 0}
};

const char short_options[] = "c:n:t:hv";

int main(int argc, char *argv[])
{
    int ret;
    char* cmd = NULL;
    int repeat_num = 1; // default
    int thread_num = 1; // default

    if (argc == 1) {
        cout << "foreach: missing command operand\n";
        cout << "Try `foreach --help' for more information." << endl;
        return 0;
    }
    
    while (true) {
        int option_index = 0;

        ret = getopt_long(argc, argv, short_options,
                          long_options, &option_index);
        
        if (ret == -1) break;
        
        switch (ret) {
            case 'n':
                repeat_num = atoi(optarg);
                break;
            case 'c':
                thread_num = atoi(optarg);
                break;
            case 'v':
                cout << "foreach " << VERSION << endl;
                return 0;
            default:
                print_help();
                return -1;
        } // end of switch
    } // end of while

    if (optind >= argc) {
        print_help();
        return -1;
    }

    // make more command
    while (optind < argc) {
        cmd = argv[optind++];

        if (repeat_num >= 1) {
            for (int i = 0; i < repeat_num; ++i) {
                system(cmd);
            }
        } // end of if
    } // end of while

    return 0;
}

void print_help()
{
    cout << "foreach : A script surporting multi thread repeat excute some command\n";
    cout << "Usage: foreach [options]... [CMD]...\n";
    cout << "Optons:\n";
    cout << "  -n,  --count=num     Set the number to repeat\n";
    cout << "  -c,  --thread=count  Set the thread counter\n";
    cout << "  -v,  --version       Show the version of the foreach and exit\n";
    cout << "  -h,  --help          Show the help" << endl;
}

